		ORG	00H
		AJMP	MAIN
		ORG	30H
MAIN:		MOV	TMOD,#20H
		MOV	TH1,#0FDH
		MOV	TL1,#0FDH	
	
		MOV	SCON,#0D8H
		MOV	PCON,#0
		SETB	TR1
		MOV	R5,#00H
LOOP:		MOV	P2,R5
		MOV	A,#0FFH
		MOV	P3,A
		JNB	P3.3,PRESTX
		JNB	P3.5,PRESRX
		JNB	P3.7,JIAYI
		AJMP	LOOP

PRESTX:		JNB	P3.3,$
		MOV	R3,#00H			;接收命令送R3
		MOV	R2,#07H			;从机1的地址送R2
		CALL	MSIO1
		MOV	R2,#0FH			;从机2的地址送R2
		CALL	MSIO1
		AJMP	LOOP

PRESRX:		JNB	P3.5,$
		MOV	R3,#01H			;发送命令送R3
		MOV	R2,#7H			;从机1的地址送R2
		CALL	MSIO1
		MOV	A,R5
		MOV	R4,A
		MOV	R2,#0FH			;从机2的地址送R2
		CALL	MSIO1
		MOV	A,R4
		ADD	A,R5
		DA	A
		MOV	R5,A
		AJMP	LOOP	

JIAYI:		JNB	P3.7,$
		INC	R5
		CLR	A
		ADD	A,R5
		DA	A
		MOV	R5,A
		AJMP	LOOP
		

MSIO1:		MOV	A,R2
		MOV	SBUF,A
		JNB	TI,$
		CLR	TI
		JNB	RI,$
		CLR	RI
		MOV	A,SBUF
		XRL	A,R2
		JZ	MSIO3
MSIO2:		MOV	SBUF,#0FFH
		SETB	TB8
		SJMP	MSIO1
MSIO3:		CLR	TB8
		MOV	SBUF,R3
		JNB	RI,$
		CLR	RI
		MOV	A,SBUF
		JNB	ACC.7,MSIO4
		SJMP	MSIO2
MSIO4:		CJNE	R3,#00,MSIO5
		JNB	ACC.0,MSIO2
STX:		MOV	SBUF,R5
		RET
MSIO5:		JNB	ACC.1,MSIO2
SRX:		JNB	RI,$
		CLR	RI
		MOV	A,SBUF
		MOV	R5,A
		RET
		END

		
