		ORG	00H
		AJMP	MAIN
		ORG	30H
MAIN:		MOV	SP,#60H
		MOV	TMOD,#20H
		MOV	TH1,#0FDH
		MOV	TL1,#0FDH	
	
		MOV	SCON,#0D8H
		MOV	PCON,#0
		SETB	TR1
		MOV	R5,#00H
		MOV	P1,#00H

LOOP:		MOV	P2,R5	
		MOV	A,#0FFH
		MOV	P3,A
		JNB	P3.3,PRESTX
		JNB	P3.5,PRESRX
		JNB	P3.7,JIAYI
		AJMP	LOOP

PRESTX:		JNB	P3.3,$
		MOV	P1,#03H
		MOV	R3,#00H			;接收命令送R3
		MOV	R2,#07H			;从机1的地址送R2
		CALL	MSIO1
		NOP
		NOP
		NOP
		MOV	R2,#0FH			;从机2的地址送R2
		CALL	MSIO1
		AJMP	LOOP

PRESRX:		JNB	P3.5,$
		MOV	P1,#5H
		MOV	R3,#01H			;发送命令送R3
		MOV	R2,#7H			;从机1的地址送R2
		CALL	MSIO1
		NOP
		NOP
		NOP
		MOV	A,R5
		MOV	R4,A
		MOV	R2,#0FH			;从机2的地址送R2
		CALL	MSIO1
		MOV	A,R4
		ADD	A,R5
		DA	A
		MOV	R5,A
		AJMP	LOOP	

JIAYI:		JNB	P3.7,$
		MOV	P1,#7H
		INC	R5
		CLR	A
		ADD	A,R5
		DA	A
		MOV	R5,A
		AJMP	LOOP
		

MSIO1:		SETB	TB8
		MOV	A,R2
		MOV	SBUF,A
		JNB	TI,$
		CLR	TI
		CLR	TB8
		MOV	A,R3
		MOV	SBUF,A
		JNB	TI,$
		CLR	TI
		CJNE	A,#00H,SRX		
STX:		CLR	TB8
		MOV	A,R5
		MOV	SBUF,A
		JNB	TI,$
		CLR	TI
		RET

SRX:		JNB	RI,$
		CLR	RI
		MOV	A,SBUF
		MOV	R5,A
		RET
		END

		